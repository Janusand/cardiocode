<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Heart Diagnosis</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(120deg, #e0f7fa, #80deea);
            color: #333;
            text-align: center;
        }

        .container {
            width: 80%;
            max-width: 500px;
            margin: 5% auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .step {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #00796b;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 10px;
            font-weight: bold;
            opacity: 0.5;
            transition: 0.3s;
        }

        .step.active {
            opacity: 1;
            background: #004d40;
            transform: scale(1.2);
        }

        .info {
            text-align: left;
            padding: 20px;
            width: 100%;
        }

        input, input[type="file"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: 0.3s;
        }
        
        input:focus {
            border-color: #00796b;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .btn {
            background: #00796b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
        }

        .btn:hover {
            background: #004d40;
            transform: scale(1.05);
        }

        .analyse-btn {
            background: #d32f2f;
            display: none;
            width: 100%;
            margin-top: 20px;
        }

        .analyse-btn:hover {
            background: #b71c1c;
        }

        .hidden {
            display: none;
        }

        #results {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
            text-align: left;
        }

        .result-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .high-risk {
            color: #d32f2f;
            font-weight: bold;
        }

        .normal-risk {
            color: #00796b;
            font-weight: bold;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.3);
            border-radius: 50%;
            border-top-color: #00796b;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            color: #d32f2f;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .input-field {
            position: relative;
            margin-bottom: 15px;
        }

        .input-field.error input {
            border-color: #d32f2f;
        }

        .input-field.error .error-message {
            display: block;
        }

        .logout-btn {
            background: #757575;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: #616161;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: 0.3s;
            background-color: white;
        }

        select:focus {
            border-color: #00796b;
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="container" id="signup-container">
        <h2>Doctor Login</h2>
        <input type="text" id="name" placeholder="Enter Name" required>
        <input type="text" id="phone" placeholder="Enter Phone Number" required>
        <button class="btn" onclick="sendOTP()">Send OTP</button>
    </div>
    
    <div class="container hidden" id="otp-container">
        <h2>Enter OTP</h2>
        <input type="text" id="otp" placeholder="Enter OTP">
        <button class="btn" onclick="verifyOTP()">Verify OTP</button>
    </div>
    
    <div class="container hidden" id="dashboard">
        <div class="header-container">
            <h2>Welcome, Dr. <span id="userName"></span></h2>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        <p>You can start a new diagnosis or view previous records.</p>
        <button class="btn" onclick="startDiagnosis()">Start New Diagnosis</button>
    </div>
    
    <!-- Main Diagnosis Container -->
    <div class="container hidden" id="diagnosis-container">
        <div class="header-container">
            <h1>AI Heart Diagnosis ❤</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        <div class="progress">
            <div class="step active" id="step1">1</div>
            <div>—</div>
            <div class="step" id="step2">2</div>
            <div>—</div>
            <div class="step" id="step3">3</div>
            <div>—</div>
            <div class="step" id="step4">4</div>
        </div>
        <div class="info" id="stepContent"></div>
        <div class="nav-buttons">
            <button class="btn" onclick="prevStep()">← Previous</button>
            <button class="btn" onclick="nextStep()">Next →</button>
        </div>
        <button class="btn analyse-btn" id="analyseButton" onclick="analyzeAllData()">Analyse</button>
        
        <!-- Results section -->
        <div id="results" class="hidden">
            <h2>Diagnosis Results</h2>
            <div id="patientInfo" class="result-section"></div>
            <div id="ecgResults" class="result-section"></div>
            <div id="angiogramResults" class="result-section"></div>
            <div id="bloodTestResults" class="result-section"></div>
            <div id="overallAssessment"></div>
            <button class="btn" onclick="resetDiagnosis()" style="margin-top: 20px;">Start New Diagnosis</button>
        </div>
    </div>
    
    <script>
        // Authentication logic
        let generatedOTP;
        
        function sendOTP() {
            let name = document.getElementById("name").value;
            let phone = document.getElementById("phone").value;
            if (!name || !phone) {
                alert("Please enter valid details!");
                return;
            }
            generatedOTP = Math.floor(100000 + Math.random() * 900000); // Mocked OTP
            alert("Your OTP is: " + generatedOTP); // In real implementation, send via SMS
            localStorage.setItem("doctor_name", name);
            localStorage.setItem("doctor_phone", phone);
            document.getElementById("signup-container").classList.add("hidden");
            document.getElementById("otp-container").classList.remove("hidden");
        }
        
        function verifyOTP() {
            let otpInput = document.getElementById("otp").value;
            if (otpInput == generatedOTP) {
                alert("OTP Verified Successfully!");
                document.getElementById("otp-container").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                document.getElementById("userName").innerText = localStorage.getItem("doctor_name");
            } else {
                alert("Incorrect OTP. Please try again.");
            }
        }
        
        function logout() {
            // Clear session data
            localStorage.removeItem("doctor_name");
            localStorage.removeItem("doctor_phone");
            
            // Optionally clear other data or just keep patient data for future reference
            // If you want to clear all data, uncomment the next line
            // localStorage.clear();
            
            // Redirect to login page
            document.getElementById("dashboard").classList.add("hidden");
            document.getElementById("diagnosis-container").classList.add("hidden");
            document.getElementById("results").classList.add("hidden");
            document.getElementById("signup-container").classList.remove("hidden");
            
            // Reset form fields
            document.getElementById("name").value = "";
            document.getElementById("phone").value = "";
            
            // Reset the diagnosis steps if active
            currentStep = 1;
        }
        
        function startDiagnosis() {
            document.getElementById("dashboard").classList.add("hidden");
            document.getElementById("diagnosis-container").classList.remove("hidden");
            document.getElementById("results").classList.add("hidden");
            currentStep = 1;
            updateStepUI();
        }
        
        function resetDiagnosis() {
            // Clear current diagnosis data
            ["patient_name", "patient_id", "patient_age", "patient_gender",
             "ecg_analyzed", "ecg_filename", "ecg_results",
             "angiogram_analyzed", "angiogram_filename", "angiogram_results",
             "bloodTest_analyzed", "bloodTest_filename", "bloodTest_results"].forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Reset analysis data
            analysisData = {
                patient: {},
                ecg: {},
                angiogram: {},
                bloodTest: {}
            };
            
            // Hide results and show step 1
            document.getElementById("results").classList.add("hidden");
            currentStep = 1;
            updateStepUI();
        }
        
        // Diagnosis flow logic
        let currentStep = 1;
        let analysisData = {
            patient: {},
            ecg: {},
            angiogram: {},
            bloodTest: {}
        };
        
        const steps = [
            `<h2>Patient Info</h2>
             <div class="input-field" id="nameField">
                <label>Name:</label>
                <input type='text' id='patientName' placeholder='Enter patient name'>
                <div class="error-message">Patient name is required</div>
             </div>
             
             <div class="input-field" id="idField">
                <label>ID:</label>
                <input type='text' id='patientId' placeholder='Enter patient ID'>
                <div class="error-message">Patient ID is required</div>
             </div>
             
             <div class="input-field" id="ageField">
                <label>Age:</label>
                <input type='number' id='patientAge' placeholder='Enter patient age'>
                <div class="error-message">Patient age is required</div>
             </div>
             
             <div class="input-field" id="genderField">
                <label>Gender:</label>
                <select id='patientGender'>
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
                <div class="error-message">Patient gender is required</div>
             </div>
             
             <button class="btn save-btn" onclick="saveStepData()">Save Patient Info</button>
             <p id="saveMessage"></p>`,
    
            `<h2>Angiogram CT Scan</h2>
             <p>Upload angiogram scan here.</p>
             <input type='file' id='angiogramFile' accept='image/*, .pdf' onchange='previewFile(event, "angiogram")'>
             <p id='angiogramPreview'></p>
             <button class="btn save-btn" onclick="uploadFile('angiogram')">Upload</button>
             <p id="angiogramUploadStatus"></p>`,
    
            `<h2>ECG Report</h2>
             <p>Upload ECG report here.</p>
             <input type='file' id='ecgFile' accept='image/*, .pdf' onchange='previewFile(event, "ecg")'>
             <p id='ecgPreview'></p>
             <button class="btn save-btn" onclick="uploadFile('ecg')">Upload</button>
             <p id="ecgUploadStatus"></p>`,
    
            `<h2>Blood Test Report</h2>
             <p>Upload blood test report here.</p>
             <input type='file' id='bloodTestFile' accept='image/*, .pdf' onchange='previewFile(event, "bloodTest")'>
             <p id='bloodTestPreview'></p>
             <button class="btn save-btn" onclick="uploadFile('bloodTest')">Upload</button>
             <p id="bloodTestUploadStatus"></p>`
        ];
    
        function updateStepUI() {
            document.getElementById("stepContent").innerHTML = steps[currentStep - 1];
    
            document.querySelectorAll(".step").forEach((el, index) => {
                el.classList.toggle("active", index + 1 === currentStep);
            });
    
            document.getElementById("analyseButton").style.display = currentStep === 4 ? 'block' : 'none';
    
            restoreData();
        }
    
        function nextStep() {
            if (currentStep === 1) {
                // Validate patient info before proceeding
                if (!validatePatientInfo()) {
                    return;
                }
            }
            
            if (currentStep < 4) {
                currentStep++;
                updateStepUI();
            }
        }
    
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepUI();
            }
        }
        
        function validatePatientInfo() {
            let isValid = true;
            const nameField = document.getElementById("nameField");
            const idField = document.getElementById("idField");
            const ageField = document.getElementById("ageField");
            const genderField = document.getElementById("genderField");
            
            const patientName = document.getElementById("patientName").value.trim();
            const patientId = document.getElementById("patientId").value.trim();
            const patientAge = document.getElementById("patientAge").value.trim();
            const patientGender = document.getElementById("patientGender").value;
            
            // Reset validation state
            [nameField, idField, ageField, genderField].forEach(field => {
                field.classList.remove("error");
            });
            
            // Validate each field
            if (!patientName) {
                nameField.classList.add("error");
                isValid = false;
            }
            
            if (!patientId) {
                idField.classList.add("error");
                isValid = false;
            }
            
            if (!patientAge) {
                ageField.classList.add("error");
                isValid = false;
            }
            
            if (!patientGender) {
                genderField.classList.add("error");
                isValid = false;
            }
            
            return isValid;
        }
    
        function saveStepData() {
            if (!validatePatientInfo()) {
                return;
            }
            
            const patientName = document.getElementById("patientName").value.trim();
            const patientId = document.getElementById("patientId").value.trim();
            const patientAge = document.getElementById("patientAge").value.trim();
            const patientGender = document.getElementById("patientGender").value;
            
            localStorage.setItem("patient_name", patientName);
            localStorage.setItem("patient_id", patientId);
            localStorage.setItem("patient_age", patientAge);
            localStorage.setItem("patient_gender", patientGender);
            
            analysisData.patient = {
                name: patientName,
                id: patientId,
                age: patientAge,
                gender: patientGender
            };
            
            document.getElementById("saveMessage").innerText = "Patient data saved successfully ✅";
            setTimeout(() => document.getElementById("saveMessage").innerText = "", 2000);
        }
    
        function restoreData() {
            if (currentStep === 1) {
                if (document.getElementById("patientName")) {
                    document.getElementById("patientName").value = localStorage.getItem("patient_name") || "";
                    document.getElementById("patientId").value = localStorage.getItem("patient_id") || "";
                    document.getElementById("patientAge").value = localStorage.getItem("patient_age") || "";
                    document.getElementById("patientGender").value = localStorage.getItem("patient_gender") || "";
                }
            }

            // Restore file upload statuses
            ["angiogram", "ecg", "bloodTest"].forEach(type => {
                if (localStorage.getItem(`${type}_analyzed`) && document.getElementById(`${type}Preview`)) {
                    document.getElementById(`${type}Preview`).innerText = `Analyzed: ${localStorage.getItem(`${type}_filename`)}`;
                    document.getElementById(`${type}UploadStatus`).innerHTML = "✅ Analyzed successfully";
                }
            });
        }
    
        function previewFile(event, type) {
            const file = event.target.files[0];
            if (file && document.getElementById(`${type}Preview`)) {
                document.getElementById(`${type}Preview`).innerText = `Selected: ${file.name}`;
            }
        }
        
        // This function simulates uploading a file to the backend
        function uploadFile(type) {
            const fileInput = document.getElementById(`${type}File`);
            const statusElement = document.getElementById(`${type}UploadStatus`);
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert("Please select a file first!");
                return;
            }
            
            statusElement.innerHTML = `<span>Analyzing...</span><div class="loading"></div>`;
            
            // Simulate API call delay
            setTimeout(() => {
                // Simulate backend analysis results
                let analysisResult;
                
                if (type === 'ecg') {
                    analysisResult = {
                        "Heart Rate": Math.floor(Math.random() * 40) + 60, // Random between 60-100
                        "Rhythm": Math.random() > 0.7 ? "Tachycardia" : "Normal",
                        "Risk": Math.random() > 0.7 ? "Potentially Dangerous" : "Normal"
                    };
                    analysisData.ecg = analysisResult;
                } 
                else if (type === 'angiogram') {
                    const blockagePercentage = Math.floor(Math.random() * 80) + 10;
                    let condition;
                    
                    if (blockagePercentage <= 25) condition = "Normal / Mild";
                    else if (blockagePercentage <= 50) condition = "Moderate narrowing";
                    else if (blockagePercentage <= 70) condition = "Significant stenosis";
                    else condition = "Critical blockage";
                    
                    analysisResult = {
                        "Condition": condition,
                        "Blockage": blockagePercentage
                    };
                    analysisData.angiogram = analysisResult;
                } 
                else if (type === 'bloodTest') {
                    const troponin = Math.random() * 0.8;
                    const ldl = Math.random() * 150 + 50;
                    
                    analysisResult = {
                        "Troponin": troponin.toFixed(2),
                        "LDL": ldl.toFixed(1),
                        "Risk": troponin > 0.4 ? "High risk of myocardial damage" : "Normal",
                        "LDL Risk": ldl > 100 ? "High LDL level" : "Normal"
                    };
                    analysisData.bloodTest = analysisResult;
                }
                
                localStorage.setItem(`${type}_analyzed`, 'true');
                localStorage.setItem(`${type}_filename`, fileInput.files[0].name);
                localStorage.setItem(`${type}_results`, JSON.stringify(analysisResult));
                
                statusElement.innerHTML = "✅ Analyzed successfully";
            }, 2000);
        }
        
        function analyzeAllData() {
            // Check if all data is available
            if (!localStorage.getItem("ecg_analyzed") || 
                !localStorage.getItem("angiogram_analyzed") || 
                !localStorage.getItem("bloodTest_analyzed")) {
                alert("Please upload and analyze all required reports first!");
                return;
            }
            
            // Display the results
            document.getElementById("results").classList.remove("hidden");
            document.getElementById("analyseButton").style.display = "none";
            document.querySelector(".nav-buttons").style.display = "none";
            
            // Patient Info
            const patientInfo = document.getElementById("patientInfo");
            patientInfo.innerHTML = `
                <h3>Patient Information</h3>
                <p><strong>Name:</strong> ${localStorage.getItem("patient_name")}</p>
                <p><strong>ID:</strong> ${localStorage.getItem("patient_id")}</p>
                <p><strong>Age:</strong> ${localStorage.getItem("patient_age")}</p>
                <p><strong>Gender:</strong> ${localStorage.getItem("patient_gender")}</p>
            `;
            
            // ECG Results
            const ecgData = JSON.parse(localStorage.getItem("ecg_results"));
            const ecgResults = document.getElementById("ecgResults");
            ecgResults.innerHTML = `
                <h3>ECG Analysis</h3>
                <p><strong>Heart Rate:</strong> ${ecgData["Heart Rate"]} bpm</p>
                <p><strong>Rhythm:</strong> ${ecgData["Rhythm"]}</p>
                <p><strong>Risk Assessment:</strong> <span class="${ecgData["Risk"] === "Normal" ? "normal-risk" : "high-risk"}">${ecgData["Risk"]}</span></p>
            `;
            
            // Angiogram Results
            const angiogramData = JSON.parse(localStorage.getItem("angiogram_results"));
            const angiogramResults = document.getElementById("angiogramResults");
            angiogramResults.innerHTML = `
                <h3>Angiogram Analysis</h3>
                <p><strong>Condition:</strong> ${angiogramData["Condition"]}</p>
                <p><strong>Blockage:</strong> ${angiogramData["Blockage"]}%</p>
                <p><strong>Risk Assessment:</strong> <span class="${angiogramData["Blockage"] <= 50 ? "normal-risk" : "high-risk"}">${angiogramData["Blockage"] > 70 ? "High Risk" : angiogramData["Blockage"] > 50 ? "Moderate Risk" : "Low Risk"}</span></p>
            `;
            
            // Blood Test Results
            const bloodData = JSON.parse(localStorage.getItem("bloodTest_results"));
            const bloodTestResults = document.getElementById("bloodTestResults");
            bloodTestResults.innerHTML = `
                <h3>Blood Test Analysis</h3>
                <p><strong>Troponin:</strong> ${bloodData["Troponin"]} ng/mL</p>
                <p><strong>LDL Cholesterol:</strong> ${bloodData["LDL"]} mg/dL</p>
                <p><strong>Troponin Risk:</strong> <span class="${bloodData["Risk"] === "Normal" ? "normal-risk" : "high-risk"}">${bloodData["Risk"]}</span></p>
                <p><strong>LDL Risk:</strong> <span class="${bloodData["LDL Risk"] === "Normal" ? "normal-risk" : "high-risk"}">${bloodData["LDL Risk"]}</span></p>
            `;
            
            // Overall Assessment
            const overallRisk = calculateOverallRisk(ecgData, angiogramData, bloodData);
            const overallAssessment = document.getElementById("overallAssessment");
            overallAssessment.innerHTML = `
                <h3>Overall Assessment</h3>
                <p><strong>Risk Level:</strong> <span class="${overallRisk.level === "Low" ? "normal-risk" : "high-risk"}">${overallRisk.level} Risk</span></p>
                <p><strong>Recommendation:</strong> ${overallRisk.recommendation}</p>
                <p><strong>Follow-up:</strong> ${overallRisk.followUp}</p>
            `;
        }
        
        function calculateOverallRisk(ecgData, angiogramData, bloodData) {
            // Calculate risk score based on all factors
            let riskScore = 0;
            
            // ECG factors
            if (ecgData["Risk"] !== "Normal") riskScore += 2;
            if (ecgData["Rhythm"] === "Tachycardia") riskScore += 1;
            
            // Angiogram factors
            if (angiogramData["Blockage"] > 70) riskScore += 3;
            else if (angiogramData["Blockage"] > 50) riskScore += 2;
            else if (angiogramData["Blockage"] > 25) riskScore += 1;
            
            // Blood test factors
            if (bloodData["Risk"] !== "Normal") riskScore += 3;
            if (bloodData["LDL Risk"] !== "Normal") riskScore += 1;
            
            // Determine overall risk level
            let riskLevel, recommendation, followUp;
            
            if (riskScore >= 6) {
                riskLevel = "High";
                recommendation = "Immediate medical intervention is recommended. Consider cardiac catheterization and possible stent placement.";
                followUp = "Immediate cardiology consultation and hospital admission.";
            } else if (riskScore >= 3) {
                riskLevel = "Moderate";
                recommendation = "Medical management with close monitoring. Consider medication adjustments and lifestyle modifications.";
                followUp = "Schedule follow-up with cardiology within 1-2 weeks.";
            } else {
                riskLevel = "Low";
                recommendation = "Continue current medical management. Emphasize heart-healthy lifestyle.";
                followUp = "Regular check-up in 3-6 months.";
            }
            
            return {
                level: riskLevel,
                recommendation: recommendation,
                followUp: followUp
            };
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            if (localStorage.getItem("doctor_name") && localStorage.getItem("doctor_phone")) {
                document.getElementById("signup-container").classList.add("hidden");
                document.getElementById("dashboard").classList.remove("hidden");
                document.getElementById("userName").innerText = localStorage.getItem("doctor_name");
            }
        });
    </script>
</body>
</html>
